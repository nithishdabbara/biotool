<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioTool - Sequence Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-color: #1a202c; /* Fallback color */
            color: #fff;
            transition: background-image 0.5s ease-in-out;
        }

        /* --- Local Background Images --- */
        .bg-login {
            background-image: url('/images/login-bg.jpg');
        }
        .bg-register {
            background-image: url('/images/register-bg.jpg');
        }
        .bg-analyzer {
            background-image: url('/images/analyzer-bg.jpg');
        }
        .bg-history {
            /* Using the analyzer background for history as well */
            background-image: url('/images/analyzer-bg.jpg');
        }

        .hidden { display: none; }

        .glass-card {
            background: rgba(22, 28, 45, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-input {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .glass-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .history-table-row:hover { background-color: rgba(255, 255, 255, 0.05); }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
        
        <nav class="glass-card p-4 mb-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">BioTool</h1>
            <div>
                <button id="nav-analyzer-btn" class="px-4 py-2 rounded-md text-white hover:bg-white/20 transition-colors hidden">Analyzer</button>
                <button id="nav-history-btn" class="px-4 py-2 rounded-md text-white hover:bg-white/20 transition-colors hidden">History</button>
                
                <span id="auth-section">
                    <button id="nav-auth-btn" class="px-4 py-2 rounded-md text-white hover:bg-white/20 transition-colors">Login / Register</button>
                </span>
                <span id="user-section" class="hidden items-center">
                    <span id="username-display" class="mr-4 font-medium text-white"></span>
                    <button id="logout-btn" class="px-4 py-2 rounded-md text-white bg-red-500/80 hover:bg-red-600 transition-colors">Logout</button>
                </span>
            </div>
        </nav>

        <main>
            <div id="analyzer-page" class="hidden">
                 <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-white">Sequence Analyzer</h2>
                        <label for="file-upload" class="cursor-pointer bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 transition-colors">
                            Upload File
                        </label>
                        <input id="file-upload" type="file" class="hidden" accept=".txt,.fasta,.fa">
                    </div>
                    <p class="text-white/80 mb-4">Paste your sequence below or upload a .txt or .fasta file.</p>
                    <textarea id="sequenceInput" class="w-full h-40 p-3 rounded-md focus:ring-2 focus:ring-blue-400 transition glass-input" placeholder="Enter sequence here... e.g., ATGC..."></textarea>
                    <button id="analyzeBtn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">Analyze Sequence</button>
                </div>

                <div id="results" class="mt-8 glass-card p-6 hidden">
                    <div class="flex justify-between items-center border-b border-white/20 pb-2 mb-4">
                         <h3 class="text-lg font-semibold text-white">Analysis Results</h3>
                         <button id="saveBtn" class="bg-green-500/80 text-white py-1 px-3 rounded-md hover:bg-green-600 transition-colors text-sm font-semibold">Save Analysis</button>
                    </div>
                    <p id="save-message" class="text-sm text-center mb-4"></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div id="results-content" class="grid grid-cols-2 gap-4 text-white"></div>
                        <div class="relative h-64">
                             <canvas id="nucleotideChart"></canvas>
                        </div>
                    </div>
                    <div id="advanced-results" class="mt-6 border-t border-white/20 pt-4 hidden">
                        <h4 class="font-semibold text-white mb-2">Advanced Calculations:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="melting-temp-result"></div>
                            <div id="rev-comp-result" class="md:col-span-2 font-mono text-sm bg-black/20 p-3 rounded-md break-all"></div>
                        </div>
                    </div>
                    <div id="orf-results" class="mt-6 border-t border-white/20 pt-4 hidden">
                        <h4 class="font-semibold text-white mb-2">Open Reading Frames (ORFs) Found:</h4>
                        <div id="orf-list" class="font-mono text-sm bg-black/20 p-4 rounded-md max-h-48 overflow-y-auto">
                        </div>
                    </div>
                </div>
                 <div id="analyzer-login-prompt" class="mt-6 bg-yellow-400/20 border-l-4 border-yellow-400 text-yellow-200 p-4 rounded-md hidden" role="alert">
                    <p class="font-bold">Authentication Required</p>
                    <p>You must be logged in to use the sequence analyzer.</p>
                </div>
            </div>

            <div id="auth-page">
                 <div class="max-w-md mx-auto">
                    <div id="login-container" class="glass-card p-8">
                        <h2 class="text-3xl font-bold text-center mb-6 text-white">Login</h2>
                        <input type="text" id="login-username" placeholder="Username" class="w-full p-3 border rounded-md mb-4 glass-input">
                        <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border rounded-md mb-6 glass-input">
                        <button id="login-btn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-md hover:bg-green-700 transition-colors">Login</button>
                        <p id="login-message" class="mt-4 text-sm text-center"></p>
                        <p class="text-center mt-6 text-white/80 text-sm">
                            Don't have an account? 
                            <button id="show-register-btn" class="font-semibold text-indigo-300 hover:text-indigo-200 underline">Register</button>
                        </p>
                    </div>

                    <div id="register-container" class="glass-card p-8 hidden">
                        <h2 class="text-3xl font-bold text-center mb-6 text-white">Create Account</h2>
                        <input type="text" id="register-username" placeholder="Username" class="w-full p-3 border rounded-md mb-4 glass-input">
                        <input type="password" id="register-password" placeholder="Password" class="w-full p-3 border rounded-md mb-6 glass-input">
                        <button id="register-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-md hover:bg-blue-700 transition-colors">Register</button>
                        <p id="register-message" class="mt-4 text-sm text-center"></p>
                         <p class="text-center mt-6 text-white/80 text-sm">
                            Already have an account? 
                            <button id="show-login-btn" class="font-semibold text-indigo-300 hover:text-indigo-200 underline">Login</button>
                        </p>
                    </div>
                </div>
            </div>
            
            <div id="history-page" class="hidden">
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white">History</h2>
                        <button id="export-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                            Export Data
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="border-b border-white/20">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-white/80 uppercase tracking-wider">Archive ID</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-white/80 uppercase tracking-wider">Analysis Date</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-white/80 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-white/80 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-white/80 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="text-white">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-12 text-center text-sm text-white/60">
            <p>&copy; <span id="copyright-year"></span> BioTool Project Team. All Rights Reserved.</p>
        </footer>

    </div>

    <div id="report-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
        <div class="glass-card w-full max-w-4xl p-6 rounded-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-white/20 pb-3 mb-4">
                <h3 class="text-2xl font-bold text-white">Analysis Report</h3>
                <button id="close-modal-btn" class="text-3xl font-bold text-white/70 hover:text-white">&times;</button>
            </div>
            <div id="modal-content" class="text-white/90 space-y-4"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                <div class="relative h-64">
                    <canvas id="reportDoughnutChart"></canvas>
                </div>
                <div class="relative h-64">
                    <canvas id="reportRadarChart"></canvas>
                </div>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let currentUser = null;
        let nucleotideChartInstance = null;
        let reportDoughnutChartInstance = null;
        let reportRadarChartInstance = null;

        const elements = {
            nav: {
                analyzerBtn: document.getElementById('nav-analyzer-btn'),
                historyBtn: document.getElementById('nav-history-btn'),
                authBtn: document.getElementById('nav-auth-btn'),
                authSection: document.getElementById('auth-section'),
                userSection: document.getElementById('user-section'),
                usernameDisplay: document.getElementById('username-display'),
                logoutBtn: document.getElementById('logout-btn')
            },
            analyzer: {
                page: document.getElementById('analyzer-page'),
                analyzeBtn: document.getElementById('analyzeBtn'),
                sequenceInput: document.getElementById('sequenceInput'),
                resultsContainer: document.getElementById('results'),
                resultsContent: document.getElementById('results-content'),
                loginPrompt: document.getElementById('analyzer-login-prompt'),
                saveBtn: document.getElementById('saveBtn'),
                saveMessage: document.getElementById('save-message'),
                fileUpload: document.getElementById('file-upload'),
                advancedResults: document.getElementById('advanced-results'),
                meltingTempResult: document.getElementById('melting-temp-result'),
                revCompResult: document.getElementById('rev-comp-result'),
                orfResults: document.getElementById('orf-results'),
                orfList: document.getElementById('orf-list')
            },
            auth: {
                page: document.getElementById('auth-page'),
                loginContainer: document.getElementById('login-container'),
                registerContainer: document.getElementById('register-container'),
                loginUsername: document.getElementById('login-username'),
                loginPassword: document.getElementById('login-password'),
                loginBtn: document.getElementById('login-btn'),
                loginMessage: document.getElementById('login-message'),
                registerUsername: document.getElementById('register-username'),
                registerPassword: document.getElementById('register-password'),
                registerBtn: document.getElementById('register-btn'),
                registerMessage: document.getElementById('register-message'),
                showRegisterBtn: document.getElementById('show-register-btn'),
                showLoginBtn: document.getElementById('show-login-btn')
            },
            history: {
                page: document.getElementById('history-page'),
                tableBody: document.getElementById('history-table-body'),
                exportBtn: document.getElementById('export-btn')
            },
            modal: {
                overlay: document.getElementById('report-modal'),
                content: document.getElementById('modal-content'),
                closeBtn: document.getElementById('close-modal-btn')
            }
        };
        
        function showPage(pageId) {
            ['analyzer-page', 'auth-page', 'history-page'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const pageToShow = document.getElementById(pageId);
            if(pageToShow) pageToShow.classList.remove('hidden');
            
            updateBackground(pageId);

            if (pageId === 'auth-page') {
                showAuthForm('login'); 
            } else if (pageId === 'history-page') {
                handleFetchHistory();
            }
        }

        function updateBackground(pageContext) {
            const body = document.body;
            body.classList.remove('bg-login', 'bg-register', 'bg-analyzer', 'bg-history');

            switch (pageContext) {
                case 'login':
                case 'auth-page':
                    body.classList.add('bg-login');
                    break;
                case 'register':
                    body.classList.add('bg-register');
                    break;
                case 'analyzer-page':
                    body.classList.add('bg-analyzer');
                    break;
                case 'history-page':
                    body.classList.add('bg-history');
                    break;
                default:
                    body.classList.add('bg-analyzer');
            }
        }
        
        function showAuthForm(formToShow) {
            if (formToShow === 'login') {
                elements.auth.loginContainer.classList.remove('hidden');
                elements.auth.registerContainer.classList.add('hidden');
                updateBackground('login');
            } else {
                elements.auth.loginContainer.classList.add('hidden');
                elements.auth.registerContainer.classList.remove('hidden');
                updateBackground('register');
            }
        }

        function updateUIForLoginState() {
            if (currentUser) {
                elements.nav.authSection.classList.add('hidden');
                elements.nav.analyzerBtn.classList.remove('hidden');
                elements.nav.historyBtn.classList.remove('hidden');
                elements.nav.userSection.classList.remove('hidden');
                elements.nav.usernameDisplay.textContent = `Welcome, ${currentUser.username}`;
            } else {
                elements.nav.authSection.classList.remove('hidden');
                elements.nav.analyzerBtn.classList.add('hidden');
                elements.nav.historyBtn.classList.add('hidden');
                elements.nav.userSection.classList.add('hidden');
            }
        }
        
        function storeUserData(data) {
             localStorage.setItem('biotoolUser', JSON.stringify({ username: data.username, token: data.token }));
            currentUser = { username: data.username, token: data.token };
            updateUIForLoginState();
        }
        
        function handleLogout() {
            localStorage.removeItem('biotoolUser');
            currentUser = null;
            updateUIForLoginState();
            showPage('auth-page'); 
            elements.analyzer.resultsContainer.classList.add('hidden');
        }

        async function handleApiCall(endpoint, method, body, requiresAuth = false) { 
            const headers = { 'Content-Type': 'application/json' }; 
            if (requiresAuth && currentUser) { headers['Authorization'] = `Bearer ${currentUser.token}`; } 
            try { 
                const response = await fetch(`${API_BASE_URL}${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null }); 
                const responseText = await response.text(); 
                if (!response.ok) { throw new Error(responseText || `HTTP error! status: ${response.status}`); } 
                try { return JSON.parse(responseText); } catch (e) { return responseText; } 
            } catch (error) { console.error(`API call to ${endpoint} failed:`, error); throw error; } 
        }

        async function handleRegister() {
            const username = elements.auth.registerUsername.value.trim();
            const password = elements.auth.registerPassword.value.trim();
            if (!username || !password) return showMessage(elements.auth.registerMessage, "Username and password cannot be empty.", true);
            try {
                const result = await handleApiCall("/auth/register", "POST", { username, password });
                showMessage(elements.auth.registerMessage, result, false);
            } catch (error) {
                showMessage(elements.auth.registerMessage, `Registration failed: ${error.message}`, true);
            }
        }

        async function handleLogin() {
            const username = elements.auth.loginUsername.value.trim();
            const password = elements.auth.loginPassword.value.trim();
            if (!username || !password) return showMessage(elements.auth.loginMessage, "Username and password cannot be empty.", true);
            try {
                const result = await handleApiCall("/auth/login", "POST", { username, password });
                storeUserData(result);
                showMessage(elements.auth.loginMessage, "Login successful!", false);
                setTimeout(() => {
                    showPage("analyzer-page");
                    elements.auth.loginMessage.textContent = "";
                }, 1000);
            } catch (error) {
                showMessage(elements.auth.loginMessage, "Login failed: Invalid credentials.", true);
            }
        }
        
        async function handleAnalyze() {
            const sequence = elements.analyzer.sequenceInput.value.trim().toUpperCase(); 
            if (!sequence) return; 
            try { 
                const result = await handleApiCall('/sequence/analyze', 'POST', { sequence }, true); 
                const counts = result.nucleotideCounts || {}; 
                const content = `<div><strong>Sequence Type:</strong> ${result.sequenceType}</div><div><strong>Length:</strong> ${result.length}</div><div class="col-span-2"><strong>GC Content:</strong> ${result.gcContent.toFixed(2)}%</div><div class="col-span-2 break-all"><strong>RNA Transcript:</strong><br>${result.rnaTranscript || 'N/A'}</div><div class="col-span-2 break-all"><strong>Protein Sequence:</strong><br>${result.proteinSequence || 'N/A'}</div>`; 
                elements.analyzer.resultsContent.innerHTML = content; 
                elements.analyzer.resultsContainer.classList.remove('hidden'); 
                elements.analyzer.saveMessage.textContent = ''; 
                createOrUpdateNucleotideChart(counts);
                
                if (result.sequenceType === 'DNA') {
                    elements.analyzer.meltingTempResult.innerHTML = `<strong>Melting Temp (Tm):</strong> ${result.meltingTemperature.toFixed(2)} Â°C`;
                    elements.analyzer.revCompResult.innerHTML = `<strong>Reverse Complement:</strong><br>${result.reverseComplement}`;
                    elements.analyzer.advancedResults.classList.remove('hidden');

                    if (result.openReadingFrames && result.openReadingFrames.length > 0) {
                        elements.analyzer.orfList.innerHTML = result.openReadingFrames.map(orf => `<div class="p-2 border-b border-white/10 break-all">${orf}</div>`).join('');
                        elements.analyzer.orfResults.classList.remove('hidden');
                    } else {
                        elements.analyzer.orfList.innerHTML = `<div class="p-2 text-white/70">No valid ORFs found.</div>`;
                        elements.analyzer.orfResults.classList.remove('hidden');
                    }
                } else {
                    elements.analyzer.advancedResults.classList.add('hidden');
                    elements.analyzer.orfResults.classList.add('hidden');
                }

            } catch (error) { 
                alert(`Analysis failed. Error: ${error.message}`); 
                handleLogout(); 
            } 
        }
        
        function createOrUpdateNucleotideChart(counts) {
            const ctx = document.getElementById('nucleotideChart').getContext('2d');
            if (nucleotideChartInstance) nucleotideChartInstance.destroy();
            nucleotideChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Adenine (A)', 'Cytosine (C)', 'Guanine (G)', 'Thymine (T)'],
                    datasets: [{
                        label: 'Nucleotide Count',
                        data: [counts.A||0, counts.C||0, counts.G||0, counts.T||0],
                        backgroundColor: ['#36A2EB', '#FFCE56', '#4BC0C0', '#FF6384'],
                        borderColor: ['rgba(255, 255, 255, 0.2)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: 'white' } },
                        title: { display: true, text: 'Nucleotide Composition', color: 'white', font: { size: 16 } }
                    }
                }
            });
        }

        async function handleSaveAnalysis() { const sequence = elements.analyzer.sequenceInput.value.trim().toUpperCase(); if (!sequence) return; try { const result = await handleApiCall('/analysis/save', 'POST', { sequence }, true); showMessage(elements.analyzer.saveMessage, result, false); } catch (error) { showMessage(elements.analyzer.saveMessage, `Failed to save: ${error.message}`, true); } }
        
        async function handleFetchHistory() {
            try {
                const history = await handleApiCall('/analysis/history', 'GET', null, true);
                elements.history.tableBody.innerHTML = ''; 
                if (history.length === 0) {
                    elements.history.tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-white/70">No saved history found.</td></tr>';
                    return;
                }
                history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 

                history.forEach((item, index) => {
                    const row = `
                        <tr class="history-table-row border-b border-white/10">
                            <td class="px-6 py-4 whitespace-nowrap font-mono text-indigo-300">${item.archiveId || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${new Date(item.createdAt).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${item.sequenceType}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${item.status || 'N/A'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="view-report-btn text-blue-400 hover:text-blue-300 font-semibold" data-index="${index}">View</button>
                                <button class="delete-history-btn text-red-400 hover:text-red-300 font-semibold ml-4" data-id="${item.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                    elements.history.tableBody.innerHTML += row;
                });
            } catch (error) {
                elements.history.tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-400">Failed to load history: ${error.message}</td></tr>`;
            }
        }
        
        function showReportModal(analysisData) {
            const content = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>Archive ID:</strong> <span class="font-mono text-indigo-300">${analysisData.archiveId || 'N/A'}</span></div>
                    <div><strong>Date:</strong> ${new Date(analysisData.createdAt).toLocaleString()}</div>
                    <div><strong>Sequence Type:</strong> ${analysisData.sequenceType}</div>
                    <div><strong>Length:</strong> ${analysisData.sequenceLength}</div>
                    <div class="col-span-2"><strong>GC Content:</strong> ${analysisData.gcContent.toFixed(2)}%</div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/20 space-y-2">
                    <p class="font-semibold">Original Sequence:</p>
                    <p class="font-mono text-sm break-all">${analysisData.originalSequence}</p>
                </div>
                 <div class="mt-4 pt-4 border-t border-white/20 space-y-2">
                    <p class="font-semibold">RNA Transcript:</p>
                    <p class="font-mono text-sm break-all">${analysisData.rnaTranscript || 'N/A'}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-white/20 space-y-2">
                    <p class="font-semibold">Protein Sequence:</p>
                    <p class="font-mono text-sm break-all">${analysisData.proteinSequence || 'N/A'}</p>
                </div>
            `;
            elements.modal.content.innerHTML = content;
            elements.modal.overlay.classList.remove('hidden');

            const counts = { A: 0, C: 0, G: 0, T: 0 };
            for (const char of (analysisData.originalSequence || '')) {
                if (counts.hasOwnProperty(char)) { counts[char]++; }
            }

            drawReportDoughnutChart(counts);
            drawReportRadarChart(counts);
        }
        
        function drawReportDoughnutChart(counts) {
            const ctx = document.getElementById('reportDoughnutChart').getContext('2d');
            if (reportDoughnutChartInstance) reportDoughnutChartInstance.destroy();
            reportDoughnutChartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels: ['A', 'C', 'G', 'T'], datasets: [{ data: [counts.A, counts.C, counts.G, counts.T], backgroundColor: ['#36A2EB', '#FFCE56', '#4BC0C0', '#FF6384'], borderColor: 'rgba(255, 255, 255, 0.2)', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'white' } }, title: { display: true, text: 'Proportions', color: 'white', font: { size: 16 } } } }
            });
        }
        
        function drawReportRadarChart(counts) {
            const ctx = document.getElementById('reportRadarChart').getContext('2d');
            if (reportRadarChartInstance) reportRadarChartInstance.destroy();
            reportRadarChartInstance = new Chart(ctx, {
                type: 'radar', data: { labels: ['Adenine', 'Cytosine', 'Guanine', 'Thymine'], datasets: [{ label: 'Count', data: [counts.A, counts.C, counts.G, counts.T], fill: true, backgroundColor: 'rgba(54, 162, 235, 0.4)', borderColor: 'rgba(54, 162, 235, 1)', pointBackgroundColor: 'rgba(54, 162, 235, 1)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(54, 162, 235, 1)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { color: 'rgba(255, 255, 255, 0.2)' }, grid: { color: 'rgba(255, 255, 255, 0.2)' }, pointLabels: { color: 'white', font: { size: 12 } }, ticks: { color: 'white', backdropColor: 'rgba(0, 0, 0, 0.5)' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Nucleotide Balance', color: 'white', font: { size: 16 } } } }
            });
        }

        async function handleExportData() {
            try {
                const history = await handleApiCall('/analysis/history', 'GET', null, true);
                if (history.length === 0) {
                    alert("No history to export.");
                    return;
                }
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = ["Archive ID", "Date", "Type", "Length", "Status", "Sequence"];
                csvContent += headers.join(",") + "\r\n";
                history.forEach(item => {
                    const row = [`"${item.archiveId||'N/A'}"`,`"${new Date(item.createdAt).toLocaleString()}"`,`"${item.sequenceType}"`,item.sequenceLength,`"${item.status||'N/A'}"`,`"${item.originalSequence}"`];
                    csvContent += row.join(",") + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "biotool_history.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                alert(`Failed to export data: ${error.message}`);
            }
        }
        
        async function handleDeleteHistoryItem(id) {
            if (!confirm("Are you sure you want to delete this analysis? This action cannot be undone.")) {
                return;
            }
            try {
                await handleApiCall(`/analysis/${id}`, 'DELETE', null, true);
                handleFetchHistory();
            } catch (error) {
                alert(`Failed to delete analysis: ${error.message}`);
            }
        }

        function handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { let content = e.target.result; const lines = content.split(/\r\n|\n/); const sequence = lines.filter(line => !line.startsWith('>')).join('').toUpperCase(); elements.analyzer.sequenceInput.value = sequence; }; reader.readAsText(file); }
        function showMessage(element, text, isError) { element.textContent = text; element.className = `text-sm text-center mb-2 ${isError ? 'text-red-400' : 'text-green-400'}`; }

        document.addEventListener('DOMContentLoaded', () => {
            elements.nav.analyzerBtn.addEventListener('click', () => showPage('analyzer-page'));
            elements.nav.historyBtn.addEventListener('click', () => showPage('history-page'));
            elements.nav.authBtn.addEventListener('click', () => showPage('auth-page'));
            elements.nav.logoutBtn.addEventListener('click', handleLogout);
            
            elements.auth.registerBtn.addEventListener('click', handleRegister);
            elements.auth.loginBtn.addEventListener('click', handleLogin);
            elements.analyzer.analyzeBtn.addEventListener('click', handleAnalyze);
            elements.analyzer.saveBtn.addEventListener('click', handleSaveAnalysis);
            elements.analyzer.fileUpload.addEventListener('change', handleFileUpload);
            elements.history.exportBtn.addEventListener('click', handleExportData);
            
            elements.auth.loginPassword.addEventListener('keydown', (event) => { if (event.key === 'Enter') handleLogin(); });
            elements.auth.registerPassword.addEventListener('keydown', (event) => { if (event.key === 'Enter') handleRegister(); });

            elements.auth.showRegisterBtn.addEventListener('click', () => showAuthForm('register'));
            elements.auth.showLoginBtn.addEventListener('click', () => showAuthForm('login'));

            elements.modal.closeBtn.addEventListener('click', () => {
                elements.modal.overlay.classList.add('hidden');
                if (reportDoughnutChartInstance) reportDoughnutChartInstance.destroy();
                if (reportRadarChartInstance) reportRadarChartInstance.destroy();
            });

            elements.history.tableBody.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('view-report-btn')) {
                    const index = target.getAttribute('data-index');
                    handleApiCall('/analysis/history', 'GET', null, true).then(history => {
                         history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                         if (history[index]) {
                            showReportModal(history[index]);
                         }
                    });
                } else if (target.classList.contains('delete-history-btn')) {
                    const id = target.getAttribute('data-id');
                    handleDeleteHistoryItem(id);
                }
            });

            document.getElementById('copyright-year').textContent = new Date().getFullYear();

            showPage('auth-page'); 
            updateUIForLoginState();
        });

    </script>
</body>
</html>

